<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tennis Court Monitor - Central Park</title>
    <meta name="description" content="Monitor Central Park tennis court availability and receive SMS notifications when courts become available.">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #2c3e50;
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 50%, #52c86a 100%);
            min-height: 100vh;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 20% 20%, rgba(46, 204, 113, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(39, 174, 96, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(82, 200, 106, 0.05) 0%, transparent 50%);
            pointer-events: none;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .hero {
            text-align: center;
            background: linear-gradient(145deg, #ffffff 0%, #f8fffe 100%);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 
                0 20px 60px rgba(39, 174, 96, 0.15),
                0 0 0 1px rgba(39, 174, 96, 0.1);
            margin-bottom: 30px;
            border-top: 4px solid #27ae60;
            position: relative;
            overflow: hidden;
        }
        
        .hero::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(39, 174, 96, 0.03) 0%, transparent 70%);
            pointer-events: none;
        }
        
        .hero h1 {
            font-size: 2.8em;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 50%, #229954 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .hero .subtitle {
            font-size: 1.2em;
            color: #34495e;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .nyc-badge {
            display: inline-block;
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            margin: 10px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
        }
        
        .tennis-icon {
            font-size: 3em;
            margin-bottom: 15px;
            display: block;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }
        
        .nav-tabs {
            display: flex;
            background: linear-gradient(145deg, #ffffff 0%, #f8fffe 100%);
            border-radius: 15px;
            padding: 10px;
            margin-bottom: 20px;
            box-shadow: 
                0 10px 30px rgba(39, 174, 96, 0.1),
                0 0 0 1px rgba(39, 174, 96, 0.1);
            border-top: 2px solid #27ae60;
        }
        
        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            background: transparent;
            border: none;
            font-size: 16px;
            color: #2c3e50;
        }
        
        .nav-tab.active {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }
        
        .nav-tab:not(.active):hover {
            background: linear-gradient(145deg, #f0f8f0 0%, #e8f5e8 100%);
            color: #27ae60;
        }
        
        .tab-content {
            display: none;
            background: linear-gradient(145deg, #ffffff 0%, #f8fffe 100%);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 
                0 10px 30px rgba(39, 174, 96, 0.1),
                0 0 0 1px rgba(39, 174, 96, 0.1);
            margin-bottom: 20px;
            border-top: 3px solid #27ae60;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Monitor Tool Styles */
        .status-card {
            background: linear-gradient(145deg, #f8fff8 0%, #f0f8f0 100%);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border-left: 5px solid #27ae60;
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.1);
        }
        
        .available {
            border-left-color: #27ae60;
            background: linear-gradient(145deg, #e8f5e8 0%, #d4edda 100%);
            color: #155724;
        }
        
        .unavailable {
            border-left-color: #e74c3c;
            background: linear-gradient(145deg, #fdf2f2 0%, #f8d7da 100%);
            color: #721c24;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin: 25px 0;
            flex-wrap: wrap;
        }
        
        button {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 150px;
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.2);
        }
        
        button:hover {
            background: linear-gradient(135deg, #229954 0%, #27ae60 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.3);
        }
        
        button:disabled {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }
        
        .weekend-dates {
            background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
            padding: 18px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            font-weight: bold;
            color: #155724;
            border: 2px solid #27ae60;
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.1);
        }
        
        .court-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 14px;
        }
        
        .court-table th, .court-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        
        .court-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        
        .available-slot {
            background: #d4edda;
            color: #155724;
            font-weight: bold;
        }
        
        .last-checked {
            text-align: center;
            color: #6c757d;
            font-size: 14px;
            margin-top: 20px;
        }
        
        .notification-settings {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        select, input[type="tel"], input[type="text"], input[type="password"] {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 14px;
        }
        
        /* About Page Styles */
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .feature-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.3s ease;
        }
        
        .feature-card:hover {
            transform: translateY(-3px);
        }
        
        .feature-icon {
            font-size: 2em;
            margin-bottom: 10px;
            display: block;
        }
        
        .highlight {
            background: linear-gradient(135deg, #667eea20, #764ba220);
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            margin: 20px 0;
        }
        
        .contact-info {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .hero {
                padding: 25px 20px;
            }
            
            .hero h1 {
                font-size: 2em;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .auto-refresh {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="hero">
            <span class="tennis-icon">🎾</span>
            <h1>Central Park Tennis Monitor</h1>
            <div class="nyc-badge">🏙️ NYC Parks Official Courts</div>
            <p class="subtitle">Never miss an available court reservation at Central Park</p>
        </div>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('monitor')">Court Monitor</button>
            <button class="nav-tab" onclick="showTab('about')">About & Privacy</button>
        </div>
        
        <!-- Monitor Tool Tab -->
        <div id="monitor" class="tab-content active">
            <div class="weekend-dates" id="weekendDates">
                This Weekend: Loading...
            </div>
            
            <div class="controls">
                <button onclick="checkAvailability()" id="checkBtn">Check Now</button>
                <button onclick="toggleAutoRefresh()" id="autoBtn">Start Auto-Check</button>
                <button onclick="playTestSound()">Test Sound</button>
            </div>
            
            <div class="auto-refresh">
                <label for="refreshInterval">Auto-check every:</label>
                <select id="refreshInterval">
                    <option value="30">30 seconds</option>
                    <option value="60" selected>1 minute</option>
                    <option value="300">5 minutes</option>
                    <option value="600">10 minutes</option>
                </select>
            </div>
            
            <div class="notification-settings">
                <strong>⏰ Time Filters:</strong>
                <div style="margin: 10px 0;">
                    <label style="display: flex; align-items: center; margin: 5px 0;">
                        <input type="checkbox" id="morningFilter" checked style="margin-right: 8px;">
                        Morning slots (before 1:00 PM)
                    </label>
                    <label style="display: flex; align-items: center; margin: 5px 0;">
                        <input type="checkbox" id="eveningFilter" checked style="margin-right: 8px;">
                        Afternoon/Evening slots (1:00 PM and after)
                    </label>
                </div>
            </div>
            
            <div class="notification-settings">
                <strong>🔔 Notification Settings:</strong>
                <div style="margin: 10px 0;">
                    <label style="display: flex; align-items: center; margin: 5px 0;">
                        <input type="checkbox" id="soundNotifications" checked style="margin-right: 8px;">
                        Sound notifications
                    </label>
                    <label style="display: flex; align-items: center; margin: 5px 0;">
                        <input type="checkbox" id="browserNotifications" checked style="margin-right: 8px;">
                        Browser notifications
                    </label>
                    <label style="display: flex; align-items: center; margin: 5px 0;">
                        <input type="checkbox" id="smsNotifications" style="margin-right: 8px;">
                        SMS notifications
                    </label>
                </div>
                
                <div id="smsSettings" style="display: none; margin-top: 15px; padding: 15px; background: #e8f4f8; border-radius: 8px;">
                    <h4>📱 SMS Configuration</h4>
                    <div style="margin: 10px 0;">
                        <label>Phone Number (with country code):</label><br>
                        <input type="tel" id="phoneNumber" placeholder="+1234567890" style="width: 200px; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    
                    <div style="margin: 15px 0;">
                        <strong>Choose SMS Method:</strong>
                        <div style="margin: 10px 0;">
                            <label style="display: block; margin: 5px 0;">
                                <input type="radio" name="smsMethod" value="twilio" checked style="margin-right: 8px;">
                                <strong>Twilio API</strong> (Recommended - most reliable)
                            </label>
                            <div id="twilioSettings" style="margin-left: 25px;">
                                <input type="text" id="twilioSid" placeholder="Twilio Account SID" style="width: 250px; padding: 5px; margin: 5px 0; display: block;">
                                <input type="password" id="twilioToken" placeholder="Twilio Auth Token" style="width: 250px; padding: 5px; margin: 5px 0; display: block;">
                                <input type="tel" id="twilioFrom" placeholder="Twilio Phone Number" style="width: 250px; padding: 5px; margin: 5px 0; display: block;">
                                <small style="color: #666;">Get these from your <a href="https://console.twilio.com/" target="_blank">Twilio Console</a></small>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="testSMS()" style="background: #28a745; margin-top: 10px;">Test SMS</button>
                </div>
                
                <p style="margin-top: 15px; font-size: 14px; color: #666;">
                    Keep this tab open for notifications to work. By entering your phone number, you opt-in to receive SMS notifications about tennis court availability.
                </p>
            </div>
            
            <div id="results">
                <div class="loading">Click "Check Now" to start monitoring</div>
            </div>
            
            <div class="last-checked" id="lastChecked"></div>
        </div>
        
        <!-- About Tab -->
        <div id="about" class="tab-content">
            <h2>🏞️ About Central Park Tennis Monitor</h2>
            <p>This tool monitors the official NYC Parks tennis reservation system for Central Park court availability and sends notifications when courts become available for the upcoming weekend.</p>
            
            <div class="highlight">
                <h4>🎯 Central Park Tennis Center</h4>
                <p><strong>Location:</strong> 93rd Street near the West Drive, Central Park</p>
                <p><strong>Courts Monitored:</strong> Courts 19-24 (6 reservation courts)</p>
                <p><strong>Surface:</strong> Har-Tru clay courts (professional quality)</p>
                <p><strong>Hours:</strong> 6:30 AM to dusk (seasonal)</p>
                <p><strong>Cost:</strong> $15 per hour for advance reservations</p>
            </div>
            
            <div class="features">
                <div class="feature-card">
                    <span class="feature-icon">🏞️</span>
                    <h3>Central Park Focus</h3>
                    <p>Specifically designed for Central Park's premier tennis facility with 26 clay courts</p>
                </div>
                
                <div class="feature-card">
                    <span class="feature-icon">📱</span>
                    <h3>SMS Alerts</h3>
                    <p>Instant text notifications when reservation slots open up on courts 19-24</p>
                </div>
                
                <div class="feature-card">
                    <span class="feature-icon">⏰</span>
                    <h3>Smart Scheduling</h3>
                    <p>Filter for morning or evening slots to match your preferred playing times</p>
                </div>
                
                <div class="feature-card">
                    <span class="feature-icon">🎯</span>
                    <h3>Weekend Ready</h3>
                    <p>Automatically tracks the current weekend - Saturday and Sunday monitoring</p>
                </div>
            </div>
            
            <h3>🎾 How the NYC Parks System Works</h3>
            <p>The tool connects to the official NYC Parks tennis reservation system at <strong>nycgovparks.org</strong>. Central Park's Tennis Center offers 26 courts total, with courts 19-24 available for advance online reservations. The system allows bookings up to 30 days in advance for season permit holders.</p>
            
            <div class="highlight">
                <h4>📋 NYC Parks Reservation Rules</h4>
                <p><strong>Permit Required:</strong> You must have a current season tennis permit</p>
                <p><strong>Advance Booking:</strong> Reservations open 30 days ahead</p>
                <p><strong>Same Day:</strong> No same-day online reservations allowed</p>
                <p><strong>Modifications:</strong> One rebooking allowed per reservation</p>
                <p><strong>Cancellation:</strong> Must cancel 24 hours in advance for refund</p>
                <p><strong>Weather:</strong> Rained-out sessions can be rebooked during the season</p>
            </div>
            
            <div class="highlight">
                <h4>SMS Opt-In Information</h4>
                <p><strong>Voluntary Participation:</strong> Users voluntarily provide their phone number to receive SMS notifications about tennis court availability.</p>
                <p><strong>Message Content:</strong> SMS messages contain information about available court times, court numbers, and links to the reservation system.</p>
                <p><strong>Frequency:</strong> Messages are only sent when courts become available - typically 0-5 messages per day during peak season.</p>
                <p><strong>Opt-Out:</strong> Users can disable SMS notifications at any time by unchecking the SMS option in the tool.</p>
            </div>
            
            <h3>🔒 Privacy & Official Compliance</h3>
            <p>• This tool accesses only publicly available court data from the official NYC Parks website</p>
            <p>• Phone numbers are stored locally in your browser only - never transmitted except for SMS delivery</p>
            <p>• All monitoring happens client-side with no data collection on our servers</p>
            <p>• Tool operates within NYC Parks' public data access guidelines</p>
            <p>• Not affiliated with NYC Parks - this is an independent monitoring utility</p>
            
            <h3>⚖️ Technical Details & Compliance</h3>
            <p>• Monitors only the 6 reservable courts (19-24) at Central Park Tennis Center</p>
            <p>• Respects NYC Parks system rate limits and access policies</p>
            <p>• Uses official NYC Parks reservation URLs for direct booking links</p>
            <p>• SMS delivery via Twilio API with proper opt-in consent mechanisms</p>
            <p>• Browser-based operation requires no server infrastructure or data storage</p>
            
            <div class="contact-info">
                <h3>📞 Contact & Support</h3>
                <p><strong>Tool Support:</strong> <a href="mailto:tenniscourtmonitor@gmail.com" style="color: #27ae60;">tenniscourtmonitor@gmail.com</a></p>
                <p><strong>Central Park Tennis Center:</strong> (212) 280-0205</p>
                <p><strong>NYC Parks Tennis:</strong> <a href="https://www.nycgovparks.org/things-to-do/tennis" target="_blank" style="color: #27ae60;">Official Tennis Information</a></p>
                <p style="margin-top: 15px; font-size: 0.9em; color: #666;">
                    🌳 Independent monitoring tool for Central Park tennis courts • Not affiliated with NYC Parks
                </p>
            </div>
        </div>
    </div>

    <script>
        let autoRefreshInterval = null;
        let isAutoRefreshing = false;
        
        // Tab Management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }
        
        // Get this weekend's dates based on current day
        function getWeekendDates() {
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
            
            let saturday, sunday;
            
            if (dayOfWeek === 0) {
                // Today is Sunday - this weekend is today and yesterday
                sunday = new Date(today);
                saturday = new Date(today);
                saturday.setDate(today.getDate() - 1);
            } else if (dayOfWeek === 6) {
                // Today is Saturday - this weekend is today and tomorrow
                saturday = new Date(today);
                sunday = new Date(today);
                sunday.setDate(today.getDate() + 1);
            } else {
                // Monday through Friday - find the upcoming weekend
                const daysUntilSaturday = 6 - dayOfWeek;
                saturday = new Date(today);
                saturday.setDate(today.getDate() + daysUntilSaturday);
                
                sunday = new Date(saturday);
                sunday.setDate(saturday.getDate() + 1);
            }
            
            const formatDate = (date) => {
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                return `${days[date.getDay()]}, ${months[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()}`;
            };
            
            return {
                saturday: saturday,
                sunday: sunday,
                saturdayFormatted: formatDate(saturday),
                sundayFormatted: formatDate(sunday)
            };
        }
        
        // Update weekend dates display
        function updateWeekendDisplay() {
            const dates = getWeekendDates();
            const today = new Date();
            const dayOfWeek = today.getDay();
            
            let weekendLabel = "This Weekend";
            if (dayOfWeek === 0) {
                weekendLabel = "This Weekend (Today & Yesterday)";
            } else if (dayOfWeek === 6) {
                weekendLabel = "This Weekend (Today & Tomorrow)";
            } else {
                weekendLabel = "This Weekend (Upcoming)";
            }
            
            document.getElementById('weekendDates').innerHTML = 
                `${weekendLabel}: ${dates.saturdayFormatted} & ${dates.sundayFormatted}`;
        }
        
        // Play notification sound
        function playNotificationSound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // Create a more pleasant notification sound
            const frequencies = [800, 1000, 1200];
            frequencies.forEach((freq, index) => {
                setTimeout(() => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = freq;
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.5);
                }, index * 200);
            });
        }
        
        function playTestSound() {
            playNotificationSound();
        }
        
        // SMS Notification Functions
        async function sendSMS(message) {
            const smsEnabled = document.getElementById('smsNotifications').checked;
            if (!smsEnabled) return;
            
            const phoneNumber = document.getElementById('phoneNumber').value.trim();
            
            if (!phoneNumber) {
                alert('Please enter a phone number for SMS notifications');
                return;
            }
            
            await sendTwilioSMS(message, phoneNumber);
        }
        
        async function sendTwilioSMS(message, phoneNumber) {
            const accountSid = document.getElementById('twilioSid').value.trim();
            const authToken = document.getElementById('twilioToken').value.trim();
            const fromNumber = document.getElementById('twilioFrom').value.trim();
            
            if (!accountSid || !authToken || !fromNumber) {
                alert('Please fill in all Twilio credentials');
                return;
            }
            
            try {
                const response = await fetch(`https://api.twilio.com/2010-04-01/Accounts/${accountSid}/Messages.json`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Basic ' + btoa(`${accountSid}:${authToken}`),
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        'From': fromNumber,
                        'To': phoneNumber,
                        'Body': message
                    })
                });
                
                if (response.ok) {
                    showNotificationStatus('SMS sent successfully via Twilio!');
                } else {
                    const error = await response.text();
                    console.error('Twilio SMS error:', error);
                    showNotificationStatus('Failed to send SMS via Twilio');
                }
            } catch (error) {
                console.error('SMS sending error:', error);
                showNotificationStatus('Error sending SMS - check console for details');
            }
        }
        
        async function testSMS() {
            const message = "🎾 Test: Tennis court monitor is working! This is how you'll be notified when courts become available.";
            await sendSMS(message);
        }
        
        function showNotificationStatus(message) {
            const statusDiv = document.createElement('div');
            statusDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #007bff;
                color: white;
                padding: 15px;
                border-radius: 8px;
                z-index: 1000;
                max-width: 300px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            `;
            statusDiv.textContent = message;
            document.body.appendChild(statusDiv);
            
            setTimeout(() => {
                document.body.removeChild(statusDiv);
            }, 5000);
        }
        
        // Toggle SMS settings visibility
        function toggleSMSSettings() {
            const smsEnabled = document.getElementById('smsNotifications').checked;
            const smsSettings = document.getElementById('smsSettings');
            smsSettings.style.display = smsEnabled ? 'block' : 'none';
        }
        
        // Filter slots based on time preferences
        function filterSlotsByTime(slots) {
            const morningEnabled = document.getElementById('morningFilter').checked;
            const eveningEnabled = document.getElementById('eveningFilter').checked;
            
            if (!morningEnabled && !eveningEnabled) {
                return []; // No time filters selected
            }
            
            return slots.filter(slot => {
                const timeStr = slot.time.toLowerCase();
                let hour = parseInt(timeStr.split(':')[0]);
                const isPM = timeStr.includes('p');
                
                // Convert to 24-hour format
                if (isPM && hour !== 12) {
                    hour += 12;
                } else if (!isPM && hour === 12) {
                    hour = 0;
                }
                
                const isMorning = hour < 13; // Before 1 PM
                const isEvening = hour >= 13; // 1 PM and after
                
                return (morningEnabled && isMorning) || (eveningEnabled && isEvening);
            });
        }
        
        // Parse the website content to find available courts - with enhanced debugging
        function parseCourtData(htmlContent) {
            console.log("🔍 Starting HTML parsing...");
            
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');
            
            // Get weekend dates
            const dates = getWeekendDates();
            console.log("🗓️ Current weekend dates we're looking for:");
            console.log("- Saturday object:", dates.saturday);
            console.log("- Sunday object:", dates.sunday);
            
            const saturdayStr = dates.saturday.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            const sundayStr = dates.sunday.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            console.log("📅 Formatted date strings we're looking for:");
            console.log(`- Saturday: "${saturdayStr}"`);
            console.log(`- Sunday: "${sundayStr}"`);
            
            const results = {
                saturday: { available: [], date: saturdayStr },
                sunday: { available: [], date: sundayStr }
            };
            
            // Debug: Look for ALL date headers in the HTML
            console.log("🔍 Searching for all date patterns in HTML...");
            const datePatterns = htmlContent.match(/\w+,\s+\w+\s+\d{1,2},\s+\d{4}/g);
            if (datePatterns) {
                console.log("📅 Found date patterns:", datePatterns);
            } else {
                console.log("❌ No standard date patterns found");
            }
            
            // Look for Saturday/Sunday headers specifically
            const saturdayMatches = htmlContent.match(/Saturday[^<]*\d{4}/g);
            const sundayMatches = htmlContent.match(/Sunday[^<]*\d{4}/g);
            console.log("🔍 Saturday date mentions:", saturdayMatches);
            console.log("🔍 Sunday date mentions:", sundayMatches);
            
            // Look for all "Reserve this time" links first
            const reserveLinks = doc.querySelectorAll('a[href*="/tennisreservation/reservecp/"]');
            console.log(`🔗 Found ${reserveLinks.length} total reservation links`);
            
            // Sample a few links to see what dates they're for
            reserveLinks.forEach((link, index) => {
                if (index < 5) { // Only log first 5 to avoid spam
                    console.log(`Link ${index + 1}:`, {
                        text: link.textContent.trim(),
                        href: link.href,
                        context: link.parentElement?.textContent?.trim()
                    });
                }
            });
            
            // More robust parsing - look for table structure and EXACT date matching
            const tables = doc.querySelectorAll('table');
            console.log(`📊 Found ${tables.length} tables`);
            
            tables.forEach((table, tableIndex) => {
                console.log(`\n🔍 Analyzing table ${tableIndex + 1}`);
                
                // Look for date headers before this table - be more thorough
                let currentDate = '';
                let prevElement = table.previousElementSibling;
                let lookupCount = 0;
                
                // Look backwards for date information
                while (prevElement && lookupCount < 15) {
                    const text = prevElement.textContent || prevElement.innerText || '';
                    console.log(`📝 Previous element ${lookupCount}: "${text.trim()}"`);
                    
                    // More flexible date matching
                    if (text.includes('Saturday') || text.includes('Sunday')) {
                        currentDate = text.trim();
                        console.log(`📅 Found date context: "${currentDate}"`);
                        break;
                    }
                    prevElement = prevElement.previousElementSibling;
                    lookupCount++;
                }
                
                // EXACT date matching instead of fuzzy matching
                const isCurrentSaturday = currentDate.includes(saturdayStr);
                const isCurrentSunday = currentDate.includes(sundayStr);
                const isWeekendTable = isCurrentSaturday || isCurrentSunday;
                
                console.log(`🎯 Date matching results:`);
                console.log(`   - Current date context: "${currentDate}"`);
                console.log(`   - Looking for Saturday: "${saturdayStr}"`);
                console.log(`   - Looking for Sunday: "${sundayStr}"`);
                console.log(`   - Is current Saturday: ${isCurrentSaturday}`);
                console.log(`   - Is current Sunday: ${isCurrentSunday}`);
                console.log(`   - Is weekend table: ${isWeekendTable}`);
                
                if (isWeekendTable) {
                    console.log(`✅ Processing table ${tableIndex + 1} for current weekend`);
                    
                    // Parse table rows
                    const rows = table.querySelectorAll('tr');
                    console.log(`📋 Table has ${rows.length} rows`);
                    
                    rows.forEach((row, rowIndex) => {
                        const cells = row.querySelectorAll('td, th');
                        
                        // Look for time indicators in the first cell
                        if (cells.length > 0) {
                            const firstCellText = cells[0].textContent || '';
                            const timeMatch = firstCellText.match(/(\d{1,2}:\d{2}\s*[ap]\.?m\.?)/i);
                            
                            if (timeMatch) {
                                console.log(`⏰ Row ${rowIndex} time: "${timeMatch[1]}"`);
                                
                                // Check each cell in this row for "Reserve this time" links
                                cells.forEach((cell, cellIndex) => {
                                    const reserveLink = cell.querySelector('a[href*="/tennisreservation/reservecp/"]');
                                    if (reserveLink) {
                                        // Better court number detection
                                        let courtNumber = '';
                                        
                                        // Try to find court number in the table header
                                        const headerRow = table.querySelector('tr');
                                        if (headerRow && headerRow.cells[cellIndex]) {
                                            const headerText = headerRow.cells[cellIndex].textContent;
                                            const headerCourtMatch = headerText.match(/Court\s*(\d+)/i);
                                            if (headerCourtMatch) {
                                                courtNumber = headerCourtMatch[1];
                                            }
                                        }
                                        
                                        // Fallback court number detection
                                        if (!courtNumber) {
                                            courtNumber = `${19 + cellIndex - 1}`; // Central Park courts start at 19
                                        }
                                        
                                        console.log(`🎾 Found reservation link:`, {
                                            time: timeMatch[1],
                                            court: courtNumber,
                                            link: reserveLink.getAttribute('href'),
                                            cellIndex: cellIndex,
                                            date: currentDate
                                        });
                                        
                                        const slot = {
                                            time: timeMatch[1],
                                            court: courtNumber,
                                            link: reserveLink.getAttribute('href')
                                        };
                                        
                                        // Add to appropriate day with exact matching
                                        if (isCurrentSaturday) {
                                            results.saturday.available.push(slot);
                                            console.log(`➕ Added to Saturday: ${slot.time} Court ${slot.court}`);
                                        } else if (isCurrentSunday) {
                                            results.sunday.available.push(slot);
                                            console.log(`➕ Added to Sunday: ${slot.time} Court ${slot.court}`);
                                        }
                                    }
                                });
                            }
                        }
                    });
                } else {
                    console.log(`⏭️ Skipping table ${tableIndex + 1} - not current weekend`);
                }
            });
            
            console.log("📊 Final results:", results);
            return results;
        }
        
        // Check court availability with debugging
        async function checkAvailability() {
            const checkBtn = document.getElementById('checkBtn');
            const resultsDiv = document.getElementById('results');
            
            checkBtn.disabled = true;
            checkBtn.textContent = 'Checking...';
            resultsDiv.innerHTML = '<div class="loading">Checking court availability...</div>';
            
            // Debug info
            let debugInfo = [];
            debugInfo.push(`🕐 Started at: ${new Date().toLocaleTimeString()}`);
            
            try {
                // Try multiple proxy services with different approaches
                const proxies = [
                    {
                        name: 'AllOrigins (get)',
                        url: 'https://api.allorigins.win/get?url=',
                        type: 'json'
                    },
                    {
                        name: 'AllOrigins (raw)',
                        url: 'https://api.allorigins.win/raw?url=',
                        type: 'text'
                    },
                    {
                        name: 'ThingProxy',
                        url: 'https://thingproxy.freeboard.io/fetch/',
                        type: 'text'
                    },
                    {
                        name: 'CORS Proxy (alternative)',
                        url: 'https://api.codetabs.com/v1/proxy/?quest=',
                        type: 'text'
                    }
                ];
                
                const targetUrl = 'https://www.nycgovparks.org/tennisreservation/availability/12';
                debugInfo.push(`🎯 Target URL: ${targetUrl}`);
                
                let response = null;
                let htmlContent = '';
                let proxyUsed = '';
                
                for (let i = 0; i < proxies.length; i++) {
                    const proxy = proxies[i];
                    const fullUrl = proxy.url + encodeURIComponent(targetUrl);
                    
                    try {
                        debugInfo.push(`🔄 Trying ${proxy.name}: ${proxy.url}`);
                        
                        response = await fetch(fullUrl, {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json, text/html, */*'
                            },
                            // Remove User-Agent and other problematic headers
                            mode: 'cors'
                        });
                        
                        debugInfo.push(`📊 Response status: ${response.status} ${response.statusText}`);
                        
                        if (response.ok) {
                            if (proxy.type === 'json') {
                                const jsonData = await response.json();
                                htmlContent = jsonData.contents || jsonData.data || '';
                                debugInfo.push(`📄 JSON response, contents length: ${htmlContent.length}`);
                            } else {
                                htmlContent = await response.text();
                                debugInfo.push(`📄 Text response length: ${htmlContent.length}`);
                            }
                            
                            if (htmlContent.length > 100) {
                                proxyUsed = proxy.name;
                                debugInfo.push(`✅ Success with ${proxy.name}`);
                                break;
                            } else {
                                debugInfo.push(`⚠️ Response too short from ${proxy.name}`);
                            }
                        } else {
                            debugInfo.push(`❌ Failed with ${proxy.name} (${response.status})`);
                        }
                    } catch (proxyError) {
                        debugInfo.push(`❌ Proxy error: ${proxy.name} - ${proxyError.message}`);
                        continue;
                    }
                }
                
                if (!htmlContent || htmlContent.length < 100) {
                    // Last resort: try direct fetch (will probably fail but worth trying)
                    debugInfo.push(`🔄 Trying direct fetch as last resort...`);
                    try {
                        response = await fetch(targetUrl, { mode: 'no-cors' });
                        debugInfo.push(`📊 Direct fetch status: ${response.status}`);
                    } catch (directError) {
                        debugInfo.push(`❌ Direct fetch failed: ${directError.message}`);
                    }
                    
                    throw new Error('All proxy attempts failed or returned empty content');
                }
                
                debugInfo.push(`🔍 First 200 chars: ${htmlContent.substring(0, 200)}...`);
                
                // Check if we got actual HTML or an error page
                if (htmlContent.includes('<html') || htmlContent.includes('<!DOCTYPE') || htmlContent.includes('<table')) {
                    debugInfo.push(`✅ Valid HTML received`);
                } else {
                    debugInfo.push(`⚠️ Response doesn't look like HTML`);
                    debugInfo.push(`📝 Full response preview: ${htmlContent.substring(0, 500)}`);
                }
                
                debugInfo.push(`🔧 Parsing court data...`);
                const courtData = parseCourtData(htmlContent);
                debugInfo.push(`📊 Raw Saturday slots: ${courtData.saturday.available.length}`);
                debugInfo.push(`📊 Raw Sunday slots: ${courtData.sunday.available.length}`);
                
                // Apply time filters
                courtData.saturday.available = filterSlotsByTime(courtData.saturday.available);
                courtData.sunday.available = filterSlotsByTime(courtData.sunday.available);
                
                debugInfo.push(`🎯 Filtered Saturday slots: ${courtData.saturday.available.length}`);
                debugInfo.push(`🎯 Filtered Sunday slots: ${courtData.sunday.available.length}`);
                
                displayResults(courtData);
                updateLastChecked();
                
                // Show debug info in console
                console.log('Debug Info:', debugInfo);
                
                // Check if there are any available courts and send notifications
                const hasAvailable = courtData.saturday.available.length > 0 || courtData.sunday.available.length > 0;
                if (hasAvailable) {
                    const totalSlots = courtData.saturday.available.length + courtData.sunday.available.length;
                    const satSlots = courtData.saturday.available.length;
                    const sunSlots = courtData.sunday.available.length;
                    
                    let notificationMessage = `🎾 Tennis courts available! ${totalSlots} slot(s) found:\n`;
                    if (satSlots > 0) notificationMessage += `Saturday: ${satSlots} slot(s)\n`;
                    if (sunSlots > 0) notificationMessage += `Sunday: ${sunSlots} slot(s)\n`;
                    notificationMessage += `Book now: https://www.nycgovparks.org/tennisreservation/availability/12`;
                    
                    // Sound notification
                    if (document.getElementById('soundNotifications').checked) {
                        playNotificationSound();
                    }
                    
                    // Browser notification
                    if (document.getElementById('browserNotifications').checked && Notification.permission === 'granted') {
                        new Notification('Tennis Courts Available!', {
                            body: `${totalSlots} court slot(s) now available for this weekend.`,
                            icon: '🎾'
                        });
                    }
                    
                    // SMS notification
                    await sendSMS(notificationMessage);
                }
                
            } catch (error) {
                debugInfo.push(`💥 Error: ${error.message}`);
                debugInfo.push(`📍 Error stack: ${error.stack}`);
                
                console.error('Full error details:', error);
                console.log('Debug trace:', debugInfo);
                
                resultsDiv.innerHTML = `
                    <div class="status-card unavailable">
                        <h3>❌ Error Checking Availability</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                        
                        <div style="margin: 15px 0;">
                            <button onclick="toggleDebugInfo()" style="background: #dc3545; min-width: auto; padding: 8px 16px;">
                                Show Debug Info
                            </button>
                        </div>
                        
                        <div id="debugInfo" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px; margin: 10px 0;">
                            ${debugInfo.map(info => `<div>${info}</div>`).join('')}
                        </div>
                        
                        <p><strong>Alternative solutions:</strong></p>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li><strong>Browser Extension:</strong> Install a CORS extension temporarily</li>
                            <li><strong>Local Development:</strong> Run from localhost instead</li>
                            <li><strong>Backend Service:</strong> Set up a simple proxy server</li>
                            <li><strong>Manual Checking:</strong> Use the direct link below</li>
                        </ul>
                        
                        <p><strong>Manual check:</strong> <a href="https://www.nycgovparks.org/tennisreservation/availability/12" target="_blank">Central Park Tennis Reservations</a></p>
                        
                        <div style="margin-top: 15px; padding: 10px; background: #e8f4f8; border-radius: 5px; font-size: 0.9em;">
                            <strong>💡 Technical Note:</strong> The issue is that modern browsers block cross-origin requests for security. 
                            This is a fundamental limitation when trying to fetch external websites from a client-side application.
                        </div>
                    </div>
                `;
            }
            
            checkBtn.disabled = false;
            checkBtn.textContent = 'Check Now';
        }
        
        // Toggle debug info visibility
        function toggleDebugInfo() {
            const debugDiv = document.getElementById('debugInfo');
            const button = event.target;
            
            if (debugDiv.style.display === 'none') {
                debugDiv.style.display = 'block';
                button.textContent = 'Hide Debug Info';
            } else {
                debugDiv.style.display = 'none';
                button.textContent = 'Show Debug Info';
            }
        }
        
        // Display results
        function displayResults(courtData) {
            const resultsDiv = document.getElementById('results');
            const totalAvailable = courtData.saturday.available.length + courtData.sunday.available.length;
            
            const morningEnabled = document.getElementById('morningFilter').checked;
            const eveningEnabled = document.getElementById('eveningFilter').checked;
            
            let timeFilterText = '';
            if (morningEnabled && eveningEnabled) {
                timeFilterText = ' (all times)';
            } else if (morningEnabled) {
                timeFilterText = ' (morning slots only)';
            } else if (eveningEnabled) {
                timeFilterText = ' (afternoon/evening slots only)';
            } else {
                timeFilterText = ' (no time filters selected)';
            }
            
            let html = '';
            
            if (totalAvailable === 0) {
                html = `
                    <div class="status-card unavailable">
                        <h3>❌ No Courts Available</h3>
                        <p>No courts are currently available for reservation this weekend${timeFilterText}.</p>
                        <p><strong>Saturday:</strong> ${courtData.saturday.date} - No matching slots</p>
                        <p><strong>Sunday:</strong> ${courtData.sunday.date} - No matching slots</p>
                    </div>
                `;
            } else {
                html = `
                    <div class="status-card available">
                        <h3>✅ Courts Available!</h3>
                        <p><strong>${totalAvailable}</strong> court slot(s) available this weekend${timeFilterText}!</p>
                    </div>
                `;
                
                // Saturday results
                if (courtData.saturday.available.length > 0) {
                    html += `
                        <div class="status-card">
                            <h4>Saturday - ${courtData.saturday.date} (${courtData.saturday.available.length} slots)</h4>
                            <table class="court-table">
                                <tr><th>Time</th><th>Court</th><th>Action</th></tr>
                    `;
                    courtData.saturday.available.forEach(slot => {
                        html += `
                            <tr class="available-slot">
                                <td>${slot.time}</td>
                                <td>Court ${slot.court}</td>
                                <td><a href="https://www.nycgovparks.org${slot.link}" target="_blank">Reserve Now</a></td>
                            </tr>
                        `;
                    });
                    html += '</table></div>';
                }
                
                // Sunday results
                if (courtData.sunday.available.length > 0) {
                    html += `
                        <div class="status-card">
                            <h4>Sunday - ${courtData.sunday.date} (${courtData.sunday.available.length} slots)</h4>
                            <table class="court-table">
                                <tr><th>Time</th><th>Court</th><th>Action</th></tr>
                    `;
                    courtData.sunday.available.forEach(slot => {
                        html += `
                            <tr class="available-slot">
                                <td>${slot.time}</td>
                                <td>Court ${slot.court}</td>
                                <td><a href="https://www.nycgovparks.org${slot.link}" target="_blank">Reserve Now</a></td>
                            </tr>
                        `;
                    });
                    html += '</table></div>';
                }
            }
            
            resultsDiv.innerHTML = html;
        }
        
        // Toggle auto refresh
        function toggleAutoRefresh() {
            const autoBtn = document.getElementById('autoBtn');
            const intervalSelect = document.getElementById('refreshInterval');
            
            if (isAutoRefreshing) {
                clearInterval(autoRefreshInterval);
                autoBtn.textContent = 'Start Auto-Check';
                intervalSelect.disabled = false;
                isAutoRefreshing = false;
            } else {
                const interval = parseInt(intervalSelect.value) * 1000;
                autoRefreshInterval = setInterval(checkAvailability, interval);
                autoBtn.textContent = 'Stop Auto-Check';
                intervalSelect.disabled = true;
                isAutoRefreshing = true;
                
                // Run first check immediately
                checkAvailability();
            }
        }
        
        // Update last checked time
        function updateLastChecked() {
            const now = new Date();
            document.getElementById('lastChecked').textContent = 
                `Last checked: ${now.toLocaleTimeString()}`;
        }
        
        // Request notification permission
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }
        
        // Initialize
        window.onload = function() {
            updateWeekendDisplay();
            requestNotificationPermission();
            
            // Add event listeners
            document.getElementById('smsNotifications').addEventListener('change', toggleSMSSettings);
            
            // Load saved settings from localStorage if available
            try {
                const savedPhone = localStorage.getItem('tennisMonitor_phone');
                const savedSid = localStorage.getItem('tennisMonitor_twilioSid');
                const savedFrom = localStorage.getItem('tennisMonitor_twilioFrom');
                
                if (savedPhone) document.getElementById('phoneNumber').value = savedPhone;
                if (savedSid) document.getElementById('twilioSid').value = savedSid;
                if (savedFrom) document.getElementById('twilioFrom').value = savedFrom;
            } catch (e) {
                // localStorage not available or error reading
            }
        };
        
        // Save settings when they change
        function saveSettings() {
            try {
                localStorage.setItem('tennisMonitor_phone', document.getElementById('phoneNumber').value);
                localStorage.setItem('tennisMonitor_twilioSid', document.getElementById('twilioSid').value);
                localStorage.setItem('tennisMonitor_twilioFrom', document.getElementById('twilioFrom').value);
            } catch (e) {
                // localStorage not available
            }
        }
        
        // Add save functionality to inputs
        document.addEventListener('DOMContentLoaded', function() {
            ['phoneNumber', 'twilioSid', 'twilioFrom'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', saveSettings);
                }
            });
        });
    </script>
</body>
</html>
